---
title: "Spiny Lobster Report"
author: "Erica Johnson & Kristan Culbert"
date: "11/19/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
#load libraries
library(tidyverse)
library(kableExtra)
library(effsize)
library(plotly)
library(dplyr)
library(knitr)
library(pwr)
library(vcdExtra)
library(car)
library(onewaytests)


# size data is lobster size abundance, filtered out NAs and selected 5 sites needed for report
size = read_csv("lobster_size_abundance.csv") %>% 
  filter(SIZE != "-99999", SITE == "AQUE"| SITE == "NAPL"| SITE == "MOHK" | SITE == "IVEE"| SITE == "CARP") 

# filtered out NAs and selected 5 sites needed for report
traps = read_csv("lobster_traps (1).csv") %>% 
  filter(TRAPS !="0", SITE == "AQUE"| SITE == "NAPL"| SITE == "MOHK" | SITE == "IVEE"| SITE == "CARP") 

# read in a new file that includes total number of lobsters and number of traps at non-MPA sites by site as a function of year
abundance_traps=read_csv("lobster_abundance_traps_20122017.csv")

```



```{r, include=FALSE}
#Change lobster size data to tidy data


size_frequency = read.csv("lobster_size_abundance.csv", header = TRUE) %>% 
  filter(SIZE != "-99999", SITE == "AQUE"| SITE == "NAPL"| SITE == "MOHK" | SITE == "IVEE"| SITE == "CARP")
#header = TRUE only works with "read.csv". 

#for tidy "size" data, use this file
size_case = expand.dft(size_frequency, freq = "COUNT")
#This code only works if "header = TRUE" is put into the read.csv (note no "_") code.


traps_frequency= read.csv("lobster_traps (1).csv", header = TRUE) %>% 
  filter(TRAPS != "0", SITE == "AQUE"| SITE == "NAPL"| SITE == "MOHK" | SITE == "IVEE"| SITE == "CARP")

#for tidy "traps" data, use this file
traps_case = expand.dft(traps_frequency, freq = "TRAPS")
```


1. Lobster abundance and fishing pressure (2012 - 2017)
Describe trends in lobster abundance (counts) and fishing pressure (trap buoys) at the five locations from 2012 - 2017. Ignore transect information - we are only interested in evaluating abundance and pressure on the order of SITE. Note: you are not expected to use regression here - just think of ways to clearly describe annual totals visually and in text, noting important trends, events and differences.


```{r echo=FALSE}

#summary non MPA "lobster size" table for display
summary_non_mpa_size = size_case%>% 
  group_by(YEAR, SITE) %>% 
  filter(SITE == "AQUE"| SITE == "CARP"|SITE == "MOHK") %>% 
  count(SITE) %>% 
  spread(YEAR,n)
    
kable(summary_non_mpa_size, caption ="LTER SBC lobster abundance by non-MPA site, 2012- 2017") %>% 
    kable_styling(bootstrap_option = c("striped", "hover"), full_width = FALSE)



#summary MPA "lobster size" table for display
summary_mpa_size = size_case%>% 
  group_by(YEAR, SITE) %>% 
  filter(SITE == "IVEE"| SITE == "NAPL") %>% 
  count(SITE) %>% 
  spread(YEAR,n)
    
kable(summary_mpa_size, caption ="LTER SBC lobster abundance by MPA site, 2012- 2017") %>% 
    kable_styling(bootstrap_option = c("striped", "hover"), full_width = FALSE)

```

```{r echo=FALSE}

#summary "traps" table for display. 

summary_traps = traps_case%>% 
  group_by(YEAR, SITE) %>% 
  count(SITE) %>% 
  spread(YEAR,n)

kable(summary_traps, caption ="LTER SBC lobster traps by site, 2012- 2017", booktabs= T) %>% 
    kable_styling(bootstrap_option = c("striped", "hover"), full_width = FALSE)


```



```{r echo=FALSE}

#Plot lobster abundance and fishing pressure in non-mpa sites

ggplot(abundance_traps)+
  geom_line(aes(x=year, y=lobster, col= "Lobsters"))+
  geom_line(aes(x=year, y= traps, col= "Traps"))+
  facet_wrap(~site)+
  labs(y="Lobster Abundance (n)", x= "Year", col= "Key") +
scale_y_continuous(sec.axis = sec_axis(~., name = "Lobster Traps (n)")) +
theme_classic()+
  theme(axis.text.x=element_text(angle=60, hjust=1))
  ggtitle("Lobster Abundance and Fishing Pressure in SBC LTER Non-MPA sites, 2012-2017")


```



```{r echo=FALSE}
# lobster summary for mpa sites only
size_mpa = size%>% 
  group_by(YEAR, SITE) %>% 
  filter(SITE == "NAPL"|SITE == "IVEE")

 sum_mpa = summarize(size_mpa,COUNT = round(sum(COUNT),2))

#Plot lobster abundance in mpa sites, no fishing pressure

ggplot(sum_mpa)+
  geom_line(aes(x=YEAR, y=(COUNT), col= "Lobsters"))+
  labs(y="Lobster Abundance (n)", x= "Year", col= "Key")+
  theme_classic()+
  theme(axis.text.x=element_text(angle=60, hjust=1))+
  ggtitle("Lobster Abundance SBC LTER MPA sites, 2012-2017")+
  facet_wrap(~SITE)
```

```{r}
#Kruskal-Wallis rank sum test is used to see if there is a significant difference in lobster abundance between any MPA sites. Null = no significant  difference, Alternative = at least 1 significant difference 
k_test_count = kruskal.test(SITE~COUNT, data = size)
k_test_count
#test returned a p-value of 11.23%, inicating that we do not have enough evidence to reject the null. There is no significant difference in abundance between any two sites.



#Cliff's delta measures effect size of ranked based test
cliff_eff_count = cliff.delta(COUNT~SITE, data = size)
cliff_eff_count
#0 means data overlap, 1 means no overlap. We got a negligible Cliff's data value indicating that there is data "rank" overlap, no significant difference.

```



```{r}
#data exploration, lobster carapace size

#new data file
size_non_mpa = size %>% filter(SITE == "AQUE"| SITE == "CARP"|SITE == "MOHK")

#exploratory histogram
ggplot(size, aes(x=SIZE))+
  geom_histogram()+
  facet_wrap(~SITE)

#exploratory q-q plots
ggplot(size, aes(sample=SIZE))+
  geom_qq()+
  facet_wrap(~SITE)


#data on lobster carapace length is normally distributed

```



2. Compare mean lobster size by site in 2017
Compare mean lobster sizes (carapace length (mm)) across the five sites for lobster observations collected in 2017. 
```{r echo=FALSE}

#summary table of lobster size

size_2017 = size_case %>% 
  filter(SIZE != "-99999", YEAR == 2017) %>% 
  group_by(SITE)
        
summary_size_2017 = summarize(size_2017,
            "Mean (mm)" = round (mean(SIZE),2),
            "SD (mm)" = round(sd(SIZE),2),
            "Sample size (n)" = length(unique(SIZE)),
            "Variance" = round(var(SIZE),2) #test for equal variance
    )

kable(summary_size_2017, caption ="LTER SBC mean lobster carapace length (mm) by site in 2017") %>% 
    kable_styling(bootstrap_option = c("striped", "hover"), full_width = FALSE)

#General rule: if the greatest variances is < 4x bigger than the smallest variance, then usually those are "close enough" to assume equal variance


```



```{r}

#Variances are close- largest variance is not 4x  > smallest variance.

#One-Way Anova is used to compare mean lobster carapace lengths of the 5 different sites.:

lobster_aov = aov(SIZE ~ SITE, data = size_2017)
summary(lobster_aov)

#Null Hypothesis (H0): All means are equal, Alternative Hypothesis (HA): At least two means are NOT equal. The Anova test returned a p-value of 0.008, which is lower than the significance level. We reject the null, at least one site mean carapace length is significantly different from the other.


#Tukey's HSD
TukeyHSD(lobster_aov)

#the pairwise p-values show significant difference in the following sites: NAPL-CARP(MPA and non-MPA), and NAPL-IVEE (both MPA sites).

#I don't think this is strong enough to say that the carapace lengths between MPA and non-MPA sites differ significantly....

```



```{r}

```

3. Changes in lobster size at MPA and non-MPA sites (comparing only 2012 and 2017 sizes)

From the data description (http://sbc.lternet.edu/cgi-bin/showDataset.cgi?docid=knb-lter-sbc.77): 


At Isla Vista and Naples Reef, the two protected MPA sites (with zero fishing pressure), how do lobster sizes in 2012 and 2017 compare? At the non-MPA sites?
```{r}


#How do the changes in 2012-2017 of mpa sites compare to the changes in 2017-2017 of non-mpa sites. Is there a significant difference in the recovery of MPAs vs. non-MPAs?

#here are some visuals on size frequency data MPA vs non-MPA sites
size_2012_2017_non = size_non_mpa %>% 
  filter(SIZE != "-99999", YEAR == 2012|YEAR == 2017) %>% 
  group_by(SITE)

size_2012_2017_mpa = size_mpa %>% 
  filter(SIZE != "-99999", YEAR == 2012|YEAR == 2017) %>% 
  group_by(SITE)

ggplot(size_2012_2017_non, aes(x=SIZE))+
  geom_histogram(aes(col =SITE))+
  facet_wrap(~YEAR)+
  theme_classic()

ggplot(size_2012_2017_mpa, aes(x=SIZE))+
  geom_histogram(aes(col =SITE))+
  facet_wrap(~YEAR)+
  theme_classic()


```

```{r}
#1 all lobster sizes from all sites, years 2012 and 2017 only

#create data file with the years of interest and grouped by site
NAPL = size_case %>% 
  filter(SIZE != "-99999", YEAR == "2017"| YEAR == "2012", SITE == "NAPL") %>% 
  group_by(YEAR)

t.test(data = NAPL,alternative = "greater",  SIZE~YEAR)

#no significant change here
```
```{r}
IVEE = size_case %>% 
  filter(SIZE != "-99999", YEAR == "2017"| YEAR == "2012", SITE == "IVEE") %>% 
  group_by(YEAR)

t.test(data = IVEE,alternative = "greater",  SIZE~YEAR)

#no significant change here

```

```{r}
CARP = size_case %>% 
  filter(SIZE != "-99999", YEAR == "2017"| YEAR == "2012", SITE == "CARP") %>% 
  group_by(YEAR)

t.test(data = CARP,alternative = "greater",  SIZE~YEAR)

#no significant change here

```

```{r}
MOHK = size_case %>% 
  filter(SIZE != "-99999", YEAR == "2017"| YEAR == "2012", SITE == "MOHK") %>% 
  group_by(YEAR)

t.test(data = MOHK, SIZE~YEAR)


#significant change here
```

```{r}
AQUE = size_case %>% 
  filter(SIZE != "-99999", YEAR == "2017"| YEAR == "2012", SITE == "AQUE") %>% 
  group_by(YEAR)

t.test(data = AQUE,  SIZE~YEAR)

#no significant change
```
NOTE: In regards to number 3, MOHK, a non MPA site was the only site to show significant change from 2012 to 2017 and it was a decrease in mean carapace length. It doesn't look like fishing pressure significanlty affects carapace length...




4. Proportions of “legal” lobsters at the 5 sites in 2017
The legal minimum carapace size for lobster is 82.6 mm. What proportion of observed lobsters at each site are above the legal minimum? 
Does that proportion differ significantly across the 5 sites? 
Note: Use the chisq.test() function
```{r}
#Create a data file indicating legal and not legal lobster sizes

lobster_legal = size_case %>%
  mutate(size = ifelse(SIZE <= 82.6, "Not_Legal", "Legal")) %>% 
  filter(YEAR == 2017)
lobster_legal

#create a contingency table for the chi test
lobster_legal_table = lobster_legal %>% 
  count(SITE, size) %>% 
  spread(size, n) %>% 
  select(-SITE)
lobster_legal_table

```


```{r}

#Chi-squared test
chi_test = chisq.test(lobster_legal_table, simulate.p.value = TRUE)
chi_test

#proportions differ significantly across the 5 sites (chi test shows less than 0.01 % probability, reject the null )

```

